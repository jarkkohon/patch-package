"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var chalk_1 = require("chalk");
var child_process_1 = require("child_process");
var fs = require("fs");
var path = require("path");
var rimraf = require("rimraf");
var shellEscape = require("shell-escape");
var tmp = require("tmp");
function makePatch(packageName, appPath) {
    var nodeModulesPath = path.join(appPath, "node_modules");
    var packagePath = path.join(nodeModulesPath, packageName);
    var packageJsonPath = path.join(packagePath, "package.json");
    if (!fs.existsSync(packageJsonPath)) {
        throw new Error("Unable to find local " + packageName + " package.json at " + packageJsonPath);
    }
    var packageVersion = require(packageJsonPath).version;
    var tmpRepo = tmp.dirSync({ unsafeCleanup: true });
    var tmpRepoNodeModulesPath = path.join(tmpRepo.name, "node_modules");
    var tmpRepoPackagePath = path.join(tmpRepoNodeModulesPath, packageName);
    try {
        var patchesDir_1 = path.join(appPath, "patches");
        if (!fs.existsSync(patchesDir_1)) {
            fs.mkdirSync(patchesDir_1);
        }
        else {
            // remove exsiting patch for this package, if any
            fs.readdirSync(patchesDir_1).forEach(function (fileName) {
                if (fileName.startsWith(packageName + ":")) {
                    console.log("removing", path.join(patchesDir_1, fileName));
                    fs.unlinkSync(path.join(patchesDir_1, fileName));
                }
            });
        }
        var tmpExec = function (cmd) { return child_process_1.execSync(cmd, { cwd: tmpRepo.name }); };
        // reinstall a clean version of the user's node_modules in our tmp location
        child_process_1.execSync(shellEscape(["cp", path.join(appPath, "package.json"), tmpRepo.name]));
        child_process_1.execSync(shellEscape(["cp", path.join(appPath, "yarn.lock"), tmpRepo.name]));
        tmpExec("yarn");
        // commit the package
        fs.writeFileSync(path.join(tmpRepo.name, ".gitignore"), "!/node_modules\n");
        tmpExec("git init");
        tmpExec(shellEscape(["git", "add", "-f", path.join("node_modules", packageName)]));
        tmpExec("git commit -m init");
        // replace package with user's version
        rimraf.sync(tmpRepoPackagePath);
        child_process_1.execSync(shellEscape(["cp", "-R", packagePath, tmpRepoPackagePath]));
        // add their files to the index
        tmpExec(shellEscape(["git", "add", "-f", path.join("node_modules", packageName)]));
        // get diff of changes
        var patch = tmpExec("git diff HEAD").toString();
        if (patch.trim() === "") {
            console.warn("\u2049\uFE0F  Not creating patch file for package '" + packageName + "'");
            console.warn("\u2049\uFE0F  There don't appear to be any changes.");
        }
        else {
            var patchFileName = packageName + ":" + packageVersion + ".patch";
            fs.writeFileSync(path.join(patchesDir_1, patchFileName), patch);
            console.log("Created file patches/" + patchFileName + " " + chalk_1.green("âœ”"));
        }
    }
    catch (e) {
        console.error(e);
        throw e;
    }
    finally {
        tmpRepo.removeCallback();
    }
}
exports.default = makePatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFrZVBhdGNoLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21ha2VQYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE2QjtBQUM3QiwrQ0FBZ0Q7QUFDaEQsdUJBQXdCO0FBQ3hCLDJCQUE0QjtBQUM1QiwrQkFBZ0M7QUFDaEMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0FBQ3pDLHlCQUEwQjtBQUUxQixtQkFBa0MsV0FBbUIsRUFBRSxPQUFlO0lBQ3BFLElBQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFBO0lBQzFELElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQzNELElBQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFBO0lBQzlELEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBd0IsV0FBVyx5QkFBb0IsZUFBaUIsQ0FBQyxDQUFBO0lBQzNGLENBQUM7SUFFRCxJQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFBO0lBRXZELElBQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUNwRCxJQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQTtJQUN0RSxJQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsV0FBVyxDQUFDLENBQUE7SUFFekUsSUFBSSxDQUFDO1FB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QUFDLENBQUM7WUFDTixJQUFNLGFBQWEsR0FBTSxXQUFXLFNBQUksY0FBYyxXQUFRLENBQUE7WUFDOUQsRUFBRSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVUsRUFBRSxhQUFhLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUM3RCxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUF3QixhQUFhLFNBQUksYUFBSyxDQUFDLEdBQUcsQ0FBRyxDQUFDLENBQUE7UUFDcEUsQ0FBQztJQUNILENBQUM7SUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1gsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNoQixNQUFNLENBQUMsQ0FBQTtJQUNULENBQUM7WUFBUyxDQUFDO1FBQ1QsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFBO0lBQzFCLENBQUM7QUFDSCxDQUFDO0FBaEVELDRCQWdFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdyZWVuIH0gZnJvbSBcImNoYWxrXCJcbmltcG9ydCB7IGV4ZWNTeW5jIGFzIGV4ZWMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiXG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIlxuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiXG5pbXBvcnQgKiBhcyByaW1yYWYgZnJvbSBcInJpbXJhZlwiXG5sZXQgc2hlbGxFc2NhcGUgPSByZXF1aXJlKFwic2hlbGwtZXNjYXBlXCIpXG5pbXBvcnQgKiBhcyB0bXAgZnJvbSBcInRtcFwiXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIG1ha2VQYXRjaChwYWNrYWdlTmFtZTogc3RyaW5nLCBhcHBQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3Qgbm9kZU1vZHVsZXNQYXRoID0gcGF0aC5qb2luKGFwcFBhdGgsIFwibm9kZV9tb2R1bGVzXCIpXG4gIGNvbnN0IHBhY2thZ2VQYXRoID0gcGF0aC5qb2luKG5vZGVNb2R1bGVzUGF0aCwgcGFja2FnZU5hbWUpXG4gIGNvbnN0IHBhY2thZ2VKc29uUGF0aCA9IHBhdGguam9pbihwYWNrYWdlUGF0aCwgXCJwYWNrYWdlLmpzb25cIilcbiAgaWYgKCFmcy5leGlzdHNTeW5jKHBhY2thZ2VKc29uUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIGxvY2FsICR7cGFja2FnZU5hbWV9IHBhY2thZ2UuanNvbiBhdCAke3BhY2thZ2VKc29uUGF0aH1gKVxuICB9XG5cbiAgY29uc3QgcGFja2FnZVZlcnNpb24gPSByZXF1aXJlKHBhY2thZ2VKc29uUGF0aCkudmVyc2lvblxuXG4gIGNvbnN0IHRtcFJlcG8gPSB0bXAuZGlyU3luYyh7IHVuc2FmZUNsZWFudXA6IHRydWUgfSlcbiAgY29uc3QgdG1wUmVwb05vZGVNb2R1bGVzUGF0aCA9IHBhdGguam9pbih0bXBSZXBvLm5hbWUsIFwibm9kZV9tb2R1bGVzXCIpXG4gIGNvbnN0IHRtcFJlcG9QYWNrYWdlUGF0aCA9IHBhdGguam9pbih0bXBSZXBvTm9kZU1vZHVsZXNQYXRoLCBwYWNrYWdlTmFtZSlcblxuICB0cnkge1xuICAgIGNvbnN0IHBhdGNoZXNEaXIgPSBwYXRoLmpvaW4oYXBwUGF0aCwgXCJwYXRjaGVzXCIpXG5cbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMocGF0Y2hlc0RpcikpIHtcbiAgICAgIGZzLm1rZGlyU3luYyhwYXRjaGVzRGlyKVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyByZW1vdmUgZXhzaXRpbmcgcGF0Y2ggZm9yIHRoaXMgcGFja2FnZSwgaWYgYW55XG4gICAgICBmcy5yZWFkZGlyU3luYyhwYXRjaGVzRGlyKS5mb3JFYWNoKChmaWxlTmFtZSkgPT4ge1xuICAgICAgICBpZiAoZmlsZU5hbWUuc3RhcnRzV2l0aChwYWNrYWdlTmFtZSArIFwiOlwiKSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwicmVtb3ZpbmdcIiwgcGF0aC5qb2luKHBhdGNoZXNEaXIsIGZpbGVOYW1lKSlcbiAgICAgICAgICBmcy51bmxpbmtTeW5jKHBhdGguam9pbihwYXRjaGVzRGlyLCBmaWxlTmFtZSkpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgdG1wRXhlYyA9IChjbWQ6IHN0cmluZykgPT4gZXhlYyhjbWQsIHsgY3dkOiB0bXBSZXBvLm5hbWUgfSlcbiAgICAvLyByZWluc3RhbGwgYSBjbGVhbiB2ZXJzaW9uIG9mIHRoZSB1c2VyJ3Mgbm9kZV9tb2R1bGVzIGluIG91ciB0bXAgbG9jYXRpb25cbiAgICBleGVjKHNoZWxsRXNjYXBlKFtcImNwXCIsIHBhdGguam9pbihhcHBQYXRoLCBcInBhY2thZ2UuanNvblwiKSwgdG1wUmVwby5uYW1lXSkpXG4gICAgZXhlYyhzaGVsbEVzY2FwZShbXCJjcFwiLCBwYXRoLmpvaW4oYXBwUGF0aCwgXCJ5YXJuLmxvY2tcIiksIHRtcFJlcG8ubmFtZV0pKVxuICAgIHRtcEV4ZWMoYHlhcm5gKVxuXG4gICAgLy8gY29tbWl0IHRoZSBwYWNrYWdlXG4gICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4odG1wUmVwby5uYW1lLCBcIi5naXRpZ25vcmVcIiksIFwiIS9ub2RlX21vZHVsZXNcXG5cIilcbiAgICB0bXBFeGVjKGBnaXQgaW5pdGApXG4gICAgdG1wRXhlYyhzaGVsbEVzY2FwZShbXCJnaXRcIiwgXCJhZGRcIiwgXCItZlwiLCBwYXRoLmpvaW4oXCJub2RlX21vZHVsZXNcIiwgcGFja2FnZU5hbWUpXSkpXG4gICAgdG1wRXhlYyhgZ2l0IGNvbW1pdCAtbSBpbml0YClcblxuICAgIC8vIHJlcGxhY2UgcGFja2FnZSB3aXRoIHVzZXIncyB2ZXJzaW9uXG4gICAgcmltcmFmLnN5bmModG1wUmVwb1BhY2thZ2VQYXRoKVxuICAgIGV4ZWMoc2hlbGxFc2NhcGUoW1wiY3BcIiwgXCItUlwiLCBwYWNrYWdlUGF0aCwgdG1wUmVwb1BhY2thZ2VQYXRoXSkpXG5cbiAgICAvLyBhZGQgdGhlaXIgZmlsZXMgdG8gdGhlIGluZGV4XG4gICAgdG1wRXhlYyhzaGVsbEVzY2FwZShbXCJnaXRcIiwgXCJhZGRcIiwgXCItZlwiLCBwYXRoLmpvaW4oXCJub2RlX21vZHVsZXNcIiwgcGFja2FnZU5hbWUpXSkpXG4gICAgLy8gZ2V0IGRpZmYgb2YgY2hhbmdlc1xuICAgIGNvbnN0IHBhdGNoID0gdG1wRXhlYyhgZ2l0IGRpZmYgSEVBRGApLnRvU3RyaW5nKClcblxuICAgIGlmIChwYXRjaC50cmltKCkgPT09IFwiXCIpIHtcbiAgICAgIGNvbnNvbGUud2Fybihg4oGJ77iPICBOb3QgY3JlYXRpbmcgcGF0Y2ggZmlsZSBmb3IgcGFja2FnZSAnJHtwYWNrYWdlTmFtZX0nYClcbiAgICAgIGNvbnNvbGUud2Fybihg4oGJ77iPICBUaGVyZSBkb24ndCBhcHBlYXIgdG8gYmUgYW55IGNoYW5nZXMuYClcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcGF0Y2hGaWxlTmFtZSA9IGAke3BhY2thZ2VOYW1lfToke3BhY2thZ2VWZXJzaW9ufS5wYXRjaGBcbiAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKHBhdGNoZXNEaXIsIHBhdGNoRmlsZU5hbWUpLCBwYXRjaClcbiAgICAgIGNvbnNvbGUubG9nKGBDcmVhdGVkIGZpbGUgcGF0Y2hlcy8ke3BhdGNoRmlsZU5hbWV9ICR7Z3JlZW4oXCLinJRcIil9YClcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgdGhyb3cgZVxuICB9IGZpbmFsbHkge1xuICAgIHRtcFJlcG8ucmVtb3ZlQ2FsbGJhY2soKVxuICB9XG59XG4iXX0=